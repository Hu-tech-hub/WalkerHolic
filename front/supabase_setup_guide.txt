# Supabase 낙상 감지 시스템 설정 가이드

이 파일은 낙상 감지 시스템을 위한 Supabase 설정 방법을 안내합니다.

## 1. Supabase 프로젝트 설정

1. https://supabase.com 에서 새 프로젝트를 생성하거나 기존 프로젝트를 사용
2. 프로젝트 대시보드에서 Settings > API 메뉴로 이동
3. Project URL과 anon public key를 복사
4. .env 파일에 다음과 같이 설정:

```
VITE_SUPABASE_URL=https://your-project.supabase.co
VITE_SUPABASE_ANON_KEY=your-anon-key-here
```

## 2. fall_history 테이블 생성

이미 생성된 실제 테이블 구조:

```sql
-- fall_history 테이블 (이미 생성됨)
CREATE TABLE IF NOT EXISTS fall_history (
    id BIGSERIAL PRIMARY KEY,
    timestamp TIMESTAMPTZ NOT NULL,
    detected_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    unix_timestamp NUMERIC,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- 실시간 기능 활성화 (필수!)
ALTER PUBLICATION supabase_realtime ADD TABLE fall_history;
```

### 테이블 필드 설명:
- `id`: 기본키 (자동 증가)
- `timestamp`: 낙상이 실제로 발생한 시각
- `detected_at`: 시스템이 낙상을 감지한 시각
- `unix_timestamp`: Unix timestamp 형태의 낙상 발생 시각
- `created_at`: 레코드가 데이터베이스에 생성된 시각
- `updated_at`: 레코드가 마지막으로 수정된 시각

### ⚠️ 중요: Realtime 활성화 확인

**반드시 다음 명령어를 실행해야 합니다:**

```sql
-- 이 명령어를 반드시 실행하세요!
ALTER PUBLICATION supabase_realtime ADD TABLE fall_history;
```

이 명령어를 실행하지 않으면 실시간 알림이 작동하지 않습니다.

## 3. 행 수준 보안(RLS) 설정 (선택사항)

보안을 위해 RLS를 활성화할 수 있습니다:

```sql
-- RLS 활성화
ALTER TABLE fall_history ENABLE ROW LEVEL SECURITY;

-- 모든 사용자가 읽기 가능한 정책 (개발 단계)
CREATE POLICY "Allow read access for all users" ON fall_history 
FOR SELECT USING (true);

-- 인증된 사용자만 INSERT 가능한 정책
CREATE POLICY "Allow insert for authenticated users" ON fall_history 
FOR INSERT WITH CHECK (auth.role() = 'authenticated');
```

## 4. 테스트 데이터 삽입

시스템이 올바르게 작동하는지 테스트하려면:

```sql
-- 테스트 낙상 데이터 삽입
INSERT INTO fall_history (timestamp, detected_at, unix_timestamp) 
VALUES (
  NOW(),
  NOW(),
  EXTRACT(EPOCH FROM NOW())
);
```

또는 특정 시간으로 테스트:

```sql
-- 특정 시간으로 테스트
INSERT INTO fall_history (timestamp, detected_at, unix_timestamp) 
VALUES (
  '2025-01-15 10:30:00+09:00',
  NOW(),
  1737774600
);
```

## 5. 라즈베리파이 연동 예제

라즈베리파이에서 낙상 감지 시 데이터를 삽입하는 Python 코드 예제:

```python
import time
from supabase import create_client, Client
from datetime import datetime, timezone

# Supabase 설정
SUPABASE_URL = "https://your-project.supabase.co"
SUPABASE_KEY = "your-service-role-key"  # 서버에서는 service role key 사용

supabase: Client = create_client(SUPABASE_URL, SUPABASE_KEY)

def report_fall_detection(fall_timestamp=None):
    """낙상 감지 시 Supabase에 데이터 삽입"""
    try:
        # 낙상 발생 시각 (지정되지 않으면 현재 시각)
        if fall_timestamp is None:
            fall_time = datetime.now(timezone.utc)
        else:
            fall_time = fall_timestamp
        
        # 현재 시각 (감지된 시각)
        detected_time = datetime.now(timezone.utc)
        
        data = {
            "timestamp": fall_time.isoformat(),
            "detected_at": detected_time.isoformat(),
            "unix_timestamp": int(fall_time.timestamp())
        }
        
        result = supabase.table("fall_history").insert(data).execute()
        print(f"✅ 낙상 데이터 전송 성공: {result.data}")
        return True
        
    except Exception as e:
        print(f"❌ 낙상 데이터 전송 실패: {e}")
        return False

# 사용 예제
if __name__ == "__main__":
    # 낙상 감지 보고 (현재 시각으로)
    report_fall_detection()
    
    # 또는 특정 시각으로 보고
    fall_time = datetime(2025, 1, 15, 10, 30, 0, tzinfo=timezone.utc)
    report_fall_detection(fall_time)
```

## 6. 실시간 구독 확인

웹 애플리케이션에서 실시간 구독이 올바르게 작동하는지 확인:

1. 브라우저 개발자 도구의 콘솔에서 다음 로그를 확인:
   - "🔔 낙상 감지 실시간 구독을 시작합니다."
   - "📡 Supabase 구독 상태: SUBSCRIBED"

2. 테스트 데이터를 삽입하면 다음 로그가 나타나야 함:
   - "⚠️ 낙상 감지됨!"

## 7. 문제 해결

### 🔧 단계별 진단 방법

#### 1단계: 개발 환경 확인
- 브라우저 개발자 도구(F12) 열기
- 콘솔 탭에서 다음 로그 확인:
  ```
  ✅ Supabase 환경변수가 정상적으로 설정되었습니다.
  🔔 낙상 감지 실시간 구독을 시작합니다.
  📡 Supabase 구독 상태: SUBSCRIBED
  ```

#### 2단계: 디버깅 도구 사용
- 화면 우하단의 "🐛 디버그" 버튼 클릭
- 환경변수 확인 → 연결 테스트 → 테스트 낙상 발생 순서로 실행

### 실시간 구독이 작동하지 않는 경우:

#### A. 환경변수 문제
1. `.env` 파일이 프로젝트 루트에 있는지 확인
2. 환경변수 이름이 `VITE_` 접두사로 시작하는지 확인
3. Supabase Project URL과 anon key가 올바른지 확인
4. 개발 서버 재시작 (`npm run dev`)

#### B. Supabase 설정 문제
1. Supabase 프로젝트에서 Realtime이 활성화되어 있는지 확인
2. `ALTER PUBLICATION supabase_realtime ADD TABLE fall_history;` 명령 실행 확인
3. RLS(Row Level Security) 정책이 너무 제한적이지 않은지 확인

#### C. 네트워크 문제
1. 방화벽이 WebSocket 연결을 차단하고 있지 않은지 확인
2. 회사/학교 네트워크에서 제한이 있는지 확인
3. 브라우저에서 WebSocket을 차단하고 있지 않은지 확인

#### D. 테이블/데이터 문제
1. fall_history 테이블이 정확히 생성되었는지 확인
2. 테스트 데이터 삽입 시 오류가 발생하지 않는지 확인
3. 데이터 타입이 올바른지 확인 (특히 JSONB 필드)

### 전화 연결이 작동하지 않는 경우:
1. 디바이스에서 tel: 프로토콜을 지원하는지 확인
2. 보호자 전화번호가 올바른 형식으로 저장되어 있는지 확인
3. 모바일 브라우저에서 테스트 (PC 브라우저에서는 전화 앱이 없을 수 있음)

## 8. 보안 고려사항

- 프로덕션 환경에서는 anon key 대신 service role key 사용 권장
- RLS 정책을 적절히 설정하여 사용자별 데이터 접근 제한
- 민감한 개인정보는 암호화하여 저장
- API 요청 횟수 제한 설정 